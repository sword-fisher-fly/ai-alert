name: Build and Release

on:
  push:
    branches: [main]
    tags:
      - 'v*'
#   workflow_dispatch:
#     inputs:
#       release_version:
#         description: 'Define release version, e.g. v1.0.0'
#         required: false
#         default: 'main'
     
jobs:
  build-and-release:
    name: Build AI Alert
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true 
      # - name: Set up Node.js
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: '20'  
      #     cache: 'npm'       
      #     cache-dependency-path: 'web/package-lock.json'  

      # - name: Cache web node_modules
      #   uses: actions/cache@v4
      #   id: cache-node-modules
      #   with:
      #     path: web/node_modules 
      #     key: ${{ runner.os }}-node-${{ hashFiles('web/package-lock.json') }}
      #     # å›žé€€keyï¼šè‹¥å½“å‰keyä¸å­˜åœ¨ï¼Œä½¿ç”¨åŒç³»ç»Ÿçš„æœ€æ–°Nodeç¼“å­˜ï¼ˆå¯é€‰ï¼‰
      #     restore-keys: |
      #       ${{ runner.os }}-node-${{ hashFiles('web/package-lock.json') }}

      - name: Build with Cross-Compilation
        run: |
          go env
          mkdir -p ./bin
          echo "=== Starting make build ==="
          if ! make build; then
            echo "=== make build FAILED ==="
            exit 1
          fi
          echo "=== make build SUCCEEDED ==="
          pwd
          ls -lh ./
          ls -lh ./internal/static/dist
          mkdir -p release
          mv ./bin/* ./release/
          cp ./config/config.yaml ./release/
          ls -la ./release/

      - name: Package Artifacts
        id: package
        run: |
          TAG_NAME="${{ github.event.inputs.release_version || github.ref_name }}"
          if [[ "$TAG_NAME" == 'main' ]]; then
            SHORT_HASH=$(git rev-parse --short HEAD)
            TAG_NAME="dev-${SHORT_HASH}"
          fi
          
          FILENAME="ai-alert-${TAG_NAME}.tar.gz"
          
          cd release
          tar -czf ../$FILENAME *
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
      - name: Read CHANGELOG
        id: changelog
        run: |
          if [ -f "CHANGELOG.md" ]; then
            echo "content<<EOF" >> $GITHUB_OUTPUT
            cat CHANGELOG.md >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "content=No changelog provided." >> $GITHUB_OUTPUT
          fi
      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body: |
            ${{ steps.changelog.outputs.content }}
            
            ---
            ### ðŸ›  Build Info
            * **Filename**: `${{ steps.package.outputs.filename }}`
          note: "Artifact has been built with Go $(go version)."
          tag_name: ${{ github.event.inputs.release_version || github.ref_name }}
          files: ${{ steps.package.outputs.filename }}
          append_body: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
